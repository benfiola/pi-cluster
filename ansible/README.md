# Ansible

Ansible playbooks + roles used to help provision the cluster.

## Goals

* Bootstrap cluster nodes with appropriate dependencies and kernel parameters.
* Deploy [k3s](https://k3s.io) to server
* Deploy [k3s-agent](https://k3s.io) to agents
* Deploy [metallb](https://metallb.universe.tf/) to allocate IPs to exposed services
* Deploy [custom controller](https://github.com/benfiola/metallb-mdns) to attach mDNS hostnames to exposed IP addresses
* Deploy [longhorn](https://longhorn.io/) for persistent volume provisioning.
* Deploy [docker registry](https://docs.docker.com/registry/) to push private images to cluster
* Deploy [kubernetes dashboard](https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/) for light monitoring

## Dependencies

* `ansible`
* `askpass` (utilized by `ansible`)

## Configuration

Configuration is defined via [group_vars](./group_vars/all/main.yaml).  

## Playbooks

### `user_create.yaml`

Creates a system account with passwordless sudo enabled.  Intended to be utilized to run
 subsequent ansible plays.

### `user_delete.yaml`

Deletes an account.  Intended to be utilized to delete the default account that ships with
 base OS images (as these are insecure).

### `deploy.yaml`

Runs all supporting deployment playbooks.  Intended to be a single command designed to get
 the cluster into a full, operational state.

### `deploy_bootstrap.yaml`

Installs basic dependencies required for playbooks and additionally sets kernel parameters 
(cgroups) required by kubernetes

### `deploy_metallb.yaml`

Deploys MetalLB and a controller used to synchronize allocated IP addresses with mDNS hostnames
 for easier external connectivity.

### `deploy_longhorn.yaml`

Deploys Longhorn to the cluster

### `deploy_docker_registry.yaml`

Deploys a docker registry to the cluster (with generated TLS certificates).  Adds
 these certificates to each node in the cluster.

### `deploy_kubernetes_dashboard.yaml`

Deploys a kubernetes dashboard to the cluster.  Adds a user with cluster admin privileges
 for easy (yet insecure) monitoring.

## Libraries

### `k3s_config`

Processes the kubeconfig generated by `k3s` and replaces default values with user defined values
 to produce a more portable kubeconfig file.

### `boot_args`

Processes a `cmdline.txt` file and allows the user to define, modify and change flags in an
 ansible idiomatic way.

